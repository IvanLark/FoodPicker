<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>随机晚餐/午餐决定器</title>
    <style>
      body {
        font-family: "Microsoft YaHei", Arial, sans-serif;
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      h1 {
        color: #e74c3c;
        text-align: center;
      }
      .container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .input-group {
        display: flex;
        margin-bottom: 15px;
      }
      input[type="text"],
      select {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }
      button {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin-left: 5px;
      }
      button:hover {
        background-color: #c0392b;
      }
      ul {
        list-style-type: none;
        padding: 0;
      }
      li {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      li:last-child {
        border-bottom: none;
      }
      .delete-btn {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 4px;
        text-align: center;
        font-size: 20px;
        font-weight: bold;
        min-height: 30px;
      }
      .checkbox-container {
        margin: 15px 0;
      }
      .filter-section {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
      }
      .tag {
        display: inline-block;
        background-color: #3498db;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        margin-right: 5px;
        margin-bottom: 5px;
      }
      .category {
        display: inline-block;
        background-color: #2ecc71;
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
        margin-right: 5px;
      }
      .food-info {
        flex: 1;
      }
      .tag-container {
        margin-top: 5px;
      }
      .tag-input {
        display: flex;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .tag-pill {
        background-color: #3498db;
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        margin-right: 5px;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
      }
      .tag-pill span {
        margin-left: 5px;
        cursor: pointer;
      }
      .tabs {
        display: flex;
        margin-bottom: 15px;
        border-bottom: 1px solid #ddd;
      }
      .tab {
        padding: 10px 20px;
        cursor: pointer;
        background-color: #f1f1f1;
        border-radius: 4px 4px 0 0;
        margin-right: 5px;
      }
      .tab.active {
        background-color: #e74c3c;
        color: white;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .stats-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .stat-box {
        flex: 1;
        min-width: 200px;
        margin: 10px;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 4px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .history-item {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
      }
      .history-date {
        color: #777;
        font-size: 14px;
      }
      .chart-container {
        height: 250px;
        margin: 20px 0;
        position: relative;
      }
      .chart-bar {
        position: absolute;
        bottom: 0;
        background-color: #e74c3c;
        border-radius: 4px 4px 0 0;
        transition: height 0.5s;
        cursor: pointer;
      }
      .chart-bar:hover {
        background-color: #c0392b;
      }
      .chart-label {
        position: absolute;
        bottom: -25px;
        text-align: center;
        font-size: 12px;
        transform: rotate(-45deg);
        transform-origin: left top;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100px;
      }
      .settings-section {
        margin-bottom: 30px;
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 8px;
      }
      .settings-group {
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
      }
      .settings-group:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }
      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
      .button-group button {
        margin-left: 0;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        max-width: 500px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        margin-top: 20px;
        gap: 10px;
      }
      .preset-list {
        margin-top: 10px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
      }
      /* 老虎机动画效果样式 */
      .slot-machine {
        background-color: #fff;
        border: 3px solid #e74c3c;
        border-radius: 8px;
        overflow: hidden;
        height: 50px;
        margin: 20px auto;
        position: relative;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      .slot-window {
        height: 50px;
        overflow: hidden;
        position: relative;
        background-color: #f9f9f9;
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
      }
      .slot-container {
        position: absolute;
        transition: top 3s cubic-bezier(0.1, 0.8, 0.2, 1);
        width: 100%;
        text-align: center;
      }
      .slot-item {
        height: 50px;
        line-height: 50px;
        font-weight: bold;
        font-size: 20px;
        color: #333;
      }
      .slot-machine-lever {
        position: absolute;
        right: -40px;
        top: 50%;
        transform: translateY(-50%);
        width: 30px;
        height: 80px;
        background-color: #e74c3c;
        border-radius: 0 15px 15px 0;
        cursor: pointer;
        transition: all 0.3s;
      }
      .slot-machine-lever:after {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #c0392b;
        top: 10px;
        left: 5px;
      }
      .slot-machine-lever:hover {
        background-color: #c0392b;
      }
      .slot-machine-lever.pulled {
        transform: translateY(-50%) rotate(20deg);
      }
      .slot-result-details {
        margin-top: 20px;
        text-align: center;
        display: none;
      }
      .spin-button {
        background-color: #e74c3c;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 50px;
        cursor: pointer;
        margin: 20px auto;
        display: block;
        transition: all 0.3s;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .spin-button:hover {
        background-color: #c0392b;
        transform: scale(1.05);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>随机晚餐/午餐决定器</h1>

      <div class="tabs">
        <div class="tab active" onclick="switchTab('decide')">今日菜单</div>
        <div class="tab" onclick="switchTab('add')">添加菜品</div>
        <div class="tab" onclick="switchTab('history')">历史记录</div>
        <div class="tab" onclick="switchTab('stats')">统计</div>
        <div class="tab" onclick="switchTab('settings')">设置</div>
      </div>

      <div id="decide" class="tab-content active">
        <div class="filter-section">
          <h3>筛选条件</h3>
          <div class="input-group">
            <select id="categoryFilter">
              <option value="">所有分类</option>
              <!-- 分类选项将动态添加 -->
            </select>
          </div>

          <div id="tagFilters" style="margin-top: 10px">
            <!-- 标签筛选将动态添加 -->
          </div>

          <div class="checkbox-container">
            <input type="checkbox" id="excludeToday" />
            <label for="excludeToday">排除今天已选项目</label>
          </div>
        </div>

        <div class="slot-machine">
          <div class="slot-window">
            <div class="slot-container" id="slotContainer">
              <!-- 槽机内容将动态生成 -->
            </div>
          </div>
          <div class="slot-machine-lever" id="slotLever"></div>
        </div>

        <button class="spin-button" onclick="startSlotMachine()">
          今天吃什么？
        </button>

        <div class="slot-result-details" id="slotResultDetails">
          <!-- 结果详情将显示在这里 -->
        </div>
      </div>

      <div id="add" class="tab-content">
        <div class="input-group">
          <input type="text" id="foodInput" placeholder="输入餐馆或菜品名称" />
          <button onclick="addFood()">添加</button>
        </div>

        <div class="input-group">
          <select id="categoryInput">
            <option value="">选择分类</option>
            <option value="中餐">中餐</option>
            <option value="西餐">西餐</option>
            <option value="快餐">快餐</option>
            <option value="健康餐">健康餐</option>
            <option value="其他">其他</option>
          </select>
          <input type="text" id="newCategory" placeholder="或添加新分类" />
        </div>

        <div class="input-group">
          <input
            type="text"
            id="tagInput"
            placeholder="添加标签（用逗号分隔，如：辣,甜,素食）"
          />
        </div>

        <div class="tag-input" id="selectedTags">
          <!-- 已选标签将显示在这里 -->
        </div>

        <h2>我的餐馆/菜品列表</h2>
        <ul id="foodList">
          <!-- 食物列表将显示在这里 -->
        </ul>
      </div>

      <div id="history" class="tab-content">
        <h2>历史选择记录</h2>
        <div id="historyList">
          <!-- 历史记录将显示在这里 -->
        </div>
      </div>

      <div id="stats" class="tab-content">
        <h2>统计数据</h2>

        <div class="stats-container">
          <div class="stat-box">
            <h3>最常选择</h3>
            <div id="mostSelected">暂无数据</div>
          </div>
          <div class="stat-box">
            <h3>最近选择</h3>
            <div id="recentSelections">暂无数据</div>
          </div>
        </div>

        <h3>选择频率图表</h3>
        <div class="chart-container" id="frequencyChart">
          <!-- 图表将显示在这里 -->
        </div>
      </div>

      <div id="settings" class="tab-content">
        <h2>设置</h2>

        <div class="settings-section">
          <h3>数据导入/导出</h3>

          <div class="settings-group">
            <h4>导出数据</h4>
            <p>将您的所有数据导出为文件，方便备份或迁移。</p>
            <div class="button-group">
              <button
                onclick="exportData('json')"
                style="background-color: #3498db"
              >
                导出为JSON
              </button>
              <button
                onclick="exportData('csv')"
                style="background-color: #2ecc71"
              >
                导出为CSV
              </button>
            </div>
          </div>

          <div class="settings-group">
            <h4>导入数据</h4>
            <p>从文件导入数据，支持JSON格式。</p>
            <div class="button-group">
              <button
                onclick="document.getElementById('importFile').click()"
                style="background-color: #f39c12"
              >
                导入数据
              </button>
              <input
                type="file"
                id="importFile"
                style="display: none"
                accept=".json"
                onchange="importData(this)"
              />
            </div>
          </div>

          <div class="settings-group">
            <h4>预设食物列表</h4>
            <p>选择一个预设的食物列表快速添加。</p>
            <div class="button-group">
              <button
                onclick="loadPreset('chinese')"
                style="background-color: #9b59b6"
              >
                中式餐厅
              </button>
              <button
                onclick="loadPreset('western')"
                style="background-color: #9b59b6"
              >
                西式餐厅
              </button>
              <button
                onclick="loadPreset('fastfood')"
                style="background-color: #9b59b6"
              >
                快餐
              </button>
            </div>
          </div>
        </div>

        <div class="settings-section">
          <h3>数据管理</h3>

          <div class="settings-group">
            <h4>备份与恢复</h4>
            <div class="button-group">
              <button onclick="backupData()" style="background-color: #3498db">
                创建备份
              </button>
              <button
                onclick="document.getElementById('restoreFile').click()"
                style="background-color: #e67e22"
              >
                恢复备份
              </button>
              <input
                type="file"
                id="restoreFile"
                style="display: none"
                accept=".foodbackup"
                onchange="restoreData(this)"
              />
            </div>
          </div>

          <div class="settings-group">
            <h4>重置数据</h4>
            <p>警告：此操作将删除所有数据，无法恢复！</p>
            <div class="button-group">
              <button
                onclick="confirmReset()"
                style="background-color: #e74c3c"
              >
                重置所有数据
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 确认对话框 -->
    <div id="confirmModal" class="modal">
      <div class="modal-content">
        <h3 id="modalTitle">确认操作</h3>
        <p id="modalMessage">您确定要执行此操作吗？</p>
        <div class="modal-buttons">
          <button onclick="closeModal()" style="background-color: #7f8c8d">
            取消
          </button>
          <button id="confirmButton" style="background-color: #e74c3c">
            确认
          </button>
        </div>
      </div>
    </div>

    <script>
      // 初始化数据
      let foods = [];
      let todaySelected = [];
      let categories = ["中餐", "西餐", "快餐", "健康餐", "其他"];
      let allTags = [];
      let history = [];
      let isSpinning = false; // 是否正在旋转老虎机

      // 页面加载时从本地存储加载数据
      window.onload = function () {
        loadFoods();
        loadTodaySelected();
        loadCategories();
        loadTags();
        loadHistory();
        displayFoodList();
        updateCategoryFilter();
        updateTagFilters();
        displayHistory();
        updateStatistics();
        updateSlotMachineOptions(); // 初始化老虎机选项

        // 为老虎机拉杆添加点击事件
        document
          .getElementById("slotLever")
          .addEventListener("click", function () {
            if (!isSpinning) {
              startSlotMachine();
            }
          });
      };

      // 添加食物到列表
      function addFood() {
        const foodInput = document.getElementById("foodInput");
        const categoryInput = document.getElementById("categoryInput");
        const newCategoryInput = document.getElementById("newCategory");
        const tagInput = document.getElementById("tagInput");

        const name = foodInput.value.trim();

        if (!name) {
          alert("请输入餐馆或菜品名称！");
          return;
        }

        // 获取分类
        let category = categoryInput.value;
        if (!category && newCategoryInput.value.trim()) {
          category = newCategoryInput.value.trim();
          if (!categories.includes(category)) {
            categories.push(category);
            saveCategories();
            updateCategoryFilter();
          }
        }

        // 获取标签
        const tagString = tagInput.value.trim();
        let tags = [];
        if (tagString) {
          tags = tagString
            .split(",")
            .map((tag) => tag.trim())
            .filter((tag) => tag);

          // 更新全局标签列表
          tags.forEach((tag) => {
            if (!allTags.includes(tag)) {
              allTags.push(tag);
            }
          });
          saveTags();
          updateTagFilters();
        }

        // 创建食物对象
        const food = {
          id: Date.now().toString(), // 唯一ID
          name: name,
          category: category || "未分类",
          tags: tags,
          selectionCount: 0,
          lastSelected: null,
        };

        foods.push(food);
        saveFoods();

        // 更新所有视图
        displayFoodList();
        updateStatistics(); // 更新统计数据，以便在添加新食物后立即反映在统计页面

        // 清空输入框
        foodInput.value = "";
        categoryInput.value = "";
        newCategoryInput.value = "";
        tagInput.value = "";
        document.getElementById("selectedTags").innerHTML = "";
      }

      // 删除食物
      function deleteFood(id) {
        const index = foods.findIndex((food) => food.id === id);
        if (index !== -1) {
          // 同时从历史记录中删除相关条目
          history = history.filter((item) => item.foodId !== id);
          saveHistory();

          // 删除食物
          foods.splice(index, 1);
          saveFoods();

          // 更新所有视图
          displayFoodList();
          displayHistory();
          updateStatistics();
        }
      }

      // 显示食物列表
      function displayFoodList() {
        const foodList = document.getElementById("foodList");
        foodList.innerHTML = "";

        foods.forEach((food) => {
          const li = document.createElement("li");

          // 创建食物信息区域
          const infoDiv = document.createElement("div");
          infoDiv.className = "food-info";

          // 添加名称和分类
          const nameDiv = document.createElement("div");
          nameDiv.innerHTML = `
            <strong>${food.name}</strong>
            <span class="category">${food.category}</span>
          `;
          infoDiv.appendChild(nameDiv);

          // 添加标签
          if (food.tags && food.tags.length > 0) {
            const tagContainer = document.createElement("div");
            tagContainer.className = "tag-container";

            food.tags.forEach((tag) => {
              const tagSpan = document.createElement("span");
              tagSpan.className = "tag";
              tagSpan.textContent = tag;
              tagContainer.appendChild(tagSpan);
            });

            infoDiv.appendChild(tagContainer);
          }

          // 创建删除按钮
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "删除";
          deleteBtn.className = "delete-btn";
          deleteBtn.onclick = function () {
            deleteFood(food.id);
          };

          li.appendChild(infoDiv);
          li.appendChild(deleteBtn);
          foodList.appendChild(li);
        });
      }

      // 更新分类筛选器
      function updateCategoryFilter() {
        const categoryFilter = document.getElementById("categoryFilter");

        // 保存当前选择
        const currentSelection = categoryFilter.value;

        // 清空选项
        categoryFilter.innerHTML = '<option value="">所有分类</option>';

        // 添加分类选项
        categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category;
          option.textContent = category;
          categoryFilter.appendChild(option);
        });

        // 恢复选择
        categoryFilter.value = currentSelection;
      }

      // 更新标签筛选器
      function updateTagFilters() {
        const tagFilters = document.getElementById("tagFilters");
        tagFilters.innerHTML = "";

        if (allTags.length > 0) {
          tagFilters.innerHTML = "<strong>标签筛选:</strong> ";

          allTags.forEach((tag) => {
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.id = `tag-${tag}`;
            checkbox.value = tag;

            const label = document.createElement("label");
            label.htmlFor = `tag-${tag}`;
            label.textContent = tag;
            label.style.marginRight = "10px";

            tagFilters.appendChild(checkbox);
            tagFilters.appendChild(label);
          });
        }
      }

      // 切换标签页
      function switchTab(tabId) {
        // 隐藏所有标签内容
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });

        // 取消所有标签的活动状态
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // 显示选定的标签内容
        document.getElementById(tabId).classList.add("active");

        // 设置选定标签为活动状态
        document.querySelectorAll(".tab").forEach((tab) => {
          const tabName =
            tabId === "decide"
              ? "今日菜单"
              : tabId === "add"
              ? "添加菜品"
              : tabId === "history"
              ? "历史记录"
              : tabId === "stats"
              ? "统计"
              : "设置";
          if (tab.textContent.includes(tabName)) {
            tab.classList.add("active");
          }
        });

        // 切换到不同标签时更新相应内容
        if (tabId === "history") {
          displayHistory();
        } else if (tabId === "stats") {
          updateStatistics();
        } else if (tabId === "decide") {
          updateSlotMachineOptions();
        }
      }

      // 老虎机动画效果
      function startSlotMachine() {
        if (isSpinning) return;

        const excludeToday = document.getElementById("excludeToday").checked;
        const categoryFilter = document.getElementById("categoryFilter").value;
        const slotContainer = document.getElementById("slotContainer");
        const slotLever = document.getElementById("slotLever");
        const resultDetails = document.getElementById("slotResultDetails");

        // 获取选中的标签筛选
        const selectedTags = [];
        allTags.forEach((tag) => {
          const checkbox = document.getElementById(`tag-${tag}`);
          if (checkbox && checkbox.checked) {
            selectedTags.push(tag);
          }
        });

        // 如果没有食物，显示提示
        if (foods.length === 0) {
          alert("请先添加一些餐馆或菜品！");
          return;
        }

        // 筛选食物
        let availableFoods = [...foods];

        // 按分类筛选
        if (categoryFilter) {
          availableFoods = availableFoods.filter(
            (food) => food.category === categoryFilter
          );
        }

        // 按标签筛选
        if (selectedTags.length > 0) {
          availableFoods = availableFoods.filter((food) =>
            selectedTags.every((tag) => food.tags.includes(tag))
          );
        }

        // 如果选择排除今天已选，则过滤掉已选项目
        if (excludeToday && todaySelected.length > 0) {
          availableFoods = availableFoods.filter(
            (food) => !todaySelected.includes(food.id)
          );
        }

        // 如果过滤后没有可选项，显示提示
        if (availableFoods.length === 0) {
          alert("没有符合条件的选项！");
          return;
        }

        // 标记正在旋转
        isSpinning = true;

        // 拉杆动画
        slotLever.classList.add("pulled");

        // 隐藏上次的结果
        resultDetails.style.display = "none";

        // 生成老虎机项目
        updateSlotMachineOptions(availableFoods);

        // 随机选择一个结果
        const randomIndex = Math.floor(Math.random() * availableFoods.length);
        const selectedFood = availableFoods[randomIndex];

        // 计算滚动位置（确保选中项目位于中间）
        const totalHeight = availableFoods.length * 50;
        const targetPosition = -(randomIndex * 50);

        // 先随机滚动（向上滚动很多位置）
        slotContainer.style.transition = "none";
        slotContainer.style.top = "0px";

        setTimeout(() => {
          // 添加过渡效果并滚动到目标位置
          slotContainer.style.transition =
            "top 3s cubic-bezier(0.1, 0.8, 0.2, 1)";
          slotContainer.style.top = `${targetPosition}px`;

          // 恢复拉杆
          setTimeout(() => {
            slotLever.classList.remove("pulled");
          }, 500);

          // 完成后更新状态和显示详细结果
          setTimeout(() => {
            isSpinning = false;

            // 更新选择次数和最后选择时间
            selectedFood.selectionCount =
              (selectedFood.selectionCount || 0) + 1;
            selectedFood.lastSelected = new Date().toISOString();

            // 添加到今天已选
            if (!todaySelected.includes(selectedFood.id)) {
              todaySelected.push(selectedFood.id);
              saveTodaySelected();
            }

            // 添加到历史记录
            const historyItem = {
              foodId: selectedFood.id,
              foodName: selectedFood.name,
              category: selectedFood.category,
              date: new Date().toISOString(),
            };
            history.unshift(historyItem); // 添加到历史记录开头

            // 限制历史记录数量，保留最近100条
            if (history.length > 100) {
              history = history.slice(0, 100);
            }

            // 保存数据
            saveFoods();
            saveHistory();

            // 更新历史记录和统计数据显示
            displayHistory();
            updateStatistics();

            // 显示详细结果
            displaySlotResult(selectedFood);
          }, 3000);
        }, 50);
      }

      // 更新老虎机选项
      function updateSlotMachineOptions(availableFoods) {
        const slotContainer = document.getElementById("slotContainer");

        // 如果没有传入可用食物，则使用所有食物
        if (!availableFoods) {
          availableFoods = [...foods];
        }

        // 清空内容
        slotContainer.innerHTML = "";

        // 添加所有选项
        availableFoods.forEach((food) => {
          const slotItem = document.createElement("div");
          slotItem.className = "slot-item";
          slotItem.textContent = food.name;
          slotItem.dataset.foodId = food.id;
          slotContainer.appendChild(slotItem);
        });

        // 重置位置
        slotContainer.style.transition = "none";
        slotContainer.style.top = "0px";
      }

      // 显示老虎机结果
      function displaySlotResult(selectedFood) {
        const resultDetails = document.getElementById("slotResultDetails");

        // 显示结果详情
        resultDetails.innerHTML = `
          <h3>今天就吃：<strong>${selectedFood.name}</strong></h3>
          <div>
            <span class="category">${selectedFood.category}</span>
          </div>
        `;

        // 添加标签
        if (selectedFood.tags && selectedFood.tags.length > 0) {
          const tagContainer = document.createElement("div");
          tagContainer.style.marginTop = "5px";

          selectedFood.tags.forEach((tag) => {
            const tagSpan = document.createElement("span");
            tagSpan.className = "tag";
            tagSpan.textContent = tag;
            tagContainer.appendChild(tagSpan);
          });

          resultDetails.appendChild(tagContainer);
        }

        // 显示结果详情
        resultDetails.style.display = "block";
      }

      // 保存食物列表到本地存储
      function saveFoods() {
        localStorage.setItem("foods", JSON.stringify(foods));
      }

      // 从本地存储加载食物列表
      function loadFoods() {
        const savedFoods = localStorage.getItem("foods");
        if (savedFoods) {
          foods = JSON.parse(savedFoods);
        }
      }

      // 保存分类到本地存储
      function saveCategories() {
        localStorage.setItem("categories", JSON.stringify(categories));
      }

      // 从本地存储加载分类
      function loadCategories() {
        const savedCategories = localStorage.getItem("categories");
        if (savedCategories) {
          categories = JSON.parse(savedCategories);
        }
      }

      // 保存标签到本地存储
      function saveTags() {
        localStorage.setItem("allTags", JSON.stringify(allTags));
      }

      // 从本地存储加载标签
      function loadTags() {
        const savedTags = localStorage.getItem("allTags");
        if (savedTags) {
          allTags = JSON.parse(savedTags);
        }
      }

      // 保存今天已选到本地存储
      function saveTodaySelected() {
        localStorage.setItem("todaySelected", JSON.stringify(todaySelected));

        // 检查是否需要重置今天已选（基于日期）
        const today = new Date().toDateString();
        localStorage.setItem("lastSelectedDate", today);
      }

      // 从本地存储加载今天已选
      function loadTodaySelected() {
        const lastSelectedDate = localStorage.getItem("lastSelectedDate");
        const today = new Date().toDateString();

        // 如果日期变了，重置今天已选
        if (lastSelectedDate !== today) {
          todaySelected = [];
          localStorage.removeItem("todaySelected");
          localStorage.setItem("lastSelectedDate", today);
        } else {
          const savedSelected = localStorage.getItem("todaySelected");
          if (savedSelected) {
            todaySelected = JSON.parse(savedSelected);
          }
        }
      }

      // 显示历史记录
      function displayHistory() {
        const historyList = document.getElementById("historyList");
        historyList.innerHTML = "";

        if (history.length === 0) {
          historyList.innerHTML = "<p>暂无历史记录</p>";
          return;
        }

        // 按日期分组显示历史记录
        const groupedHistory = {};

        history.forEach((item) => {
          const date = new Date(item.date).toLocaleDateString();
          if (!groupedHistory[date]) {
            groupedHistory[date] = [];
          }
          groupedHistory[date].push(item);
        });

        // 按日期排序（从新到旧）
        const sortedDates = Object.keys(groupedHistory).sort((a, b) => {
          return new Date(b) - new Date(a);
        });

        sortedDates.forEach((date) => {
          const dateHeader = document.createElement("h3");
          dateHeader.textContent = date;
          historyList.appendChild(dateHeader);

          const items = groupedHistory[date];
          items.forEach((item) => {
            const historyItem = document.createElement("div");
            historyItem.className = "history-item";

            const nameSpan = document.createElement("span");
            nameSpan.innerHTML = `<strong>${item.foodName}</strong> <span class="category">${item.category}</span>`;

            const timeSpan = document.createElement("span");
            timeSpan.className = "history-date";
            timeSpan.textContent = new Date(item.date).toLocaleTimeString();

            historyItem.appendChild(nameSpan);
            historyItem.appendChild(timeSpan);
            historyList.appendChild(historyItem);
          });
        });
      }

      // 更新统计数据
      function updateStatistics() {
        updateMostSelected();
        updateRecentSelections();
        updateFrequencyChart();
      }

      // 更新最常选择的统计
      function updateMostSelected() {
        const mostSelectedDiv = document.getElementById("mostSelected");

        if (foods.length === 0) {
          mostSelectedDiv.textContent = "暂无数据";
          return;
        }

        // 按选择次数排序
        const sortedFoods = [...foods]
          .filter((food) => food.selectionCount > 0)
          .sort((a, b) => b.selectionCount - a.selectionCount);

        if (sortedFoods.length === 0) {
          mostSelectedDiv.textContent = "暂无数据";
          return;
        }

        mostSelectedDiv.innerHTML = "";

        // 显示前5个最常选择的食物
        const topFoods = sortedFoods.slice(0, 5);
        topFoods.forEach((food) => {
          const foodItem = document.createElement("div");
          foodItem.innerHTML = `<strong>${food.name}</strong>: ${food.selectionCount}次`;
          if (food.lastSelected) {
            foodItem.innerHTML += ` (上次: ${new Date(
              food.lastSelected
            ).toLocaleDateString()})`;
          }
          mostSelectedDiv.appendChild(foodItem);
        });
      }

      // 更新最近选择的统计
      function updateRecentSelections() {
        const recentSelectionsDiv = document.getElementById("recentSelections");

        if (history.length === 0) {
          recentSelectionsDiv.textContent = "暂无数据";
          return;
        }

        recentSelectionsDiv.innerHTML = "";

        // 显示最近5次选择
        const recentHistory = history.slice(0, 5);
        recentHistory.forEach((item) => {
          const historyItem = document.createElement("div");
          historyItem.innerHTML = `<strong>${
            item.foodName
          }</strong>: ${new Date(item.date).toLocaleDateString()}`;
          recentSelectionsDiv.appendChild(historyItem);
        });
      }

      // 更新频率图表
      function updateFrequencyChart() {
        const chartContainer = document.getElementById("frequencyChart");
        chartContainer.innerHTML = "";

        // 如果图表容器不可见，可能是因为标签页未激活，则跳过绘制
        if (chartContainer.offsetWidth === 0) {
          return;
        }

        if (
          foods.length === 0 ||
          !foods.some((food) => food.selectionCount > 0)
        ) {
          chartContainer.innerHTML = "<p>暂无数据</p>";
          return;
        }

        // 按选择次数排序，取前10个
        const topFoods = [...foods]
          .filter((food) => food.selectionCount > 0)
          .sort((a, b) => b.selectionCount - a.selectionCount)
          .slice(0, 10);

        if (topFoods.length === 0) {
          chartContainer.innerHTML = "<p>暂无数据</p>";
          return;
        }

        // 找出最大选择次数，用于计算比例
        const maxCount = Math.max(
          ...topFoods.map((food) => food.selectionCount)
        );

        // 计算每个柱子的宽度
        const barWidth = chartContainer.offsetWidth / topFoods.length - 10;

        // 创建柱状图
        topFoods.forEach((food, index) => {
          const barHeight = (food.selectionCount / maxCount) * 200; // 最高200px

          const bar = document.createElement("div");
          bar.className = "chart-bar";
          bar.style.height = `${barHeight}px`;
          bar.style.width = `${barWidth}px`;
          bar.style.left = `${index * (barWidth + 10)}px`;
          bar.title = `${food.name}: ${food.selectionCount}次`;

          const label = document.createElement("div");
          label.className = "chart-label";
          label.style.width = `${barWidth}px`;
          label.style.left = `${index * (barWidth + 10)}px`;
          label.textContent = food.name;

          chartContainer.appendChild(bar);
          chartContainer.appendChild(label);
        });
      }

      // 保存历史记录到本地存储
      function saveHistory() {
        localStorage.setItem("foodHistory", JSON.stringify(history));
      }

      // 从本地存储加载历史记录
      function loadHistory() {
        const savedHistory = localStorage.getItem("foodHistory");
        if (savedHistory) {
          history = JSON.parse(savedHistory);
        }
      }

      // 按回车键添加食物
      document
        .getElementById("foodInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            addFood();
          }
        });

      // 窗口大小改变时重新绘制图表
      window.addEventListener("resize", function () {
        if (document.getElementById("stats").classList.contains("active")) {
          updateFrequencyChart();
        }
      });

      // 添加自动刷新功能，确保数据始终保持最新
      function refreshAllViews() {
        displayFoodList();
        displayHistory();
        updateStatistics();
      }

      // 导出数据
      function exportData(format) {
        // 准备要导出的数据
        const exportData = {
          foods: foods,
          categories: categories,
          tags: allTags,
          history: history,
          version: "1.0",
        };

        let dataStr, fileName, mimeType;

        if (format === "json") {
          // 导出为JSON
          dataStr = JSON.stringify(exportData, null, 2);
          fileName = `food-decision-data-${new Date()
            .toISOString()
            .slice(0, 10)}.json`;
          mimeType = "application/json";
        } else if (format === "csv") {
          // 导出为CSV
          let csvContent = "ID,名称,分类,标签,选择次数,最后选择时间\n";

          foods.forEach((food) => {
            const tags = food.tags ? food.tags.join("|") : "";
            const lastSelected = food.lastSelected ? food.lastSelected : "";
            csvContent += `${food.id},"${food.name}","${
              food.category
            }","${tags}",${food.selectionCount || 0},"${lastSelected}"\n`;
          });

          dataStr = csvContent;
          fileName = `food-decision-data-${new Date()
            .toISOString()
            .slice(0, 10)}.csv`;
          mimeType = "text/csv";
        } else {
          alert("不支持的格式");
          return;
        }

        // 创建下载链接
        const blob = new Blob([dataStr], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.setAttribute("href", url);
        a.setAttribute("download", fileName);
        a.style.display = "none";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // 导入数据
      function importData(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const importedData = JSON.parse(e.target.result);

            // 验证导入的数据格式
            if (!importedData.foods || !Array.isArray(importedData.foods)) {
              throw new Error("无效的数据格式");
            }

            // 显示确认对话框
            showConfirmModal(
              "导入数据",
              `确定要导入这些数据吗？这将替换您当前的所有数据。<br>导入内容：${
                importedData.foods.length
              } 个食物项目，${
                importedData.history ? importedData.history.length : 0
              } 条历史记录。`,
              function () {
                // 导入数据
                foods = importedData.foods;

                if (
                  importedData.categories &&
                  Array.isArray(importedData.categories)
                ) {
                  categories = importedData.categories;
                }

                if (importedData.tags && Array.isArray(importedData.tags)) {
                  allTags = importedData.tags;
                }

                if (
                  importedData.history &&
                  Array.isArray(importedData.history)
                ) {
                  history = importedData.history;
                }

                // 保存数据
                saveFoods();
                saveCategories();
                saveTags();
                saveHistory();

                // 刷新视图
                refreshAllViews();

                alert("数据导入成功！");
                closeModal();
              }
            );
          } catch (error) {
            alert("导入失败：" + error.message);
          }

          // 重置文件输入
          input.value = "";
        };

        reader.readAsText(file);
      }

      // 加载预设食物列表
      function loadPreset(presetName) {
        let presetFoods = [];

        switch (presetName) {
          case "chinese":
            presetFoods = [
              { name: "川菜馆", category: "中餐", tags: ["辣", "川菜"] },
              { name: "粤菜馆", category: "中餐", tags: ["清淡", "粤菜"] },
              { name: "火锅店", category: "中餐", tags: ["辣", "火锅"] },
              { name: "小笼包", category: "中餐", tags: ["早餐", "点心"] },
              { name: "烤鸭店", category: "中餐", tags: ["北京菜"] },
              { name: "兰州拉面", category: "中餐", tags: ["面食"] },
              { name: "沙县小吃", category: "中餐", tags: ["快餐", "面食"] },
              { name: "麻辣烫", category: "中餐", tags: ["辣", "快餐"] },
            ];
            break;
          case "western":
            presetFoods = [
              {
                name: "意大利餐厅",
                category: "西餐",
                tags: ["意大利菜", "披萨", "面食"],
              },
              { name: "法式餐厅", category: "西餐", tags: ["法国菜", "高档"] },
              { name: "牛排馆", category: "西餐", tags: ["牛排", "高档"] },
              {
                name: "墨西哥餐厅",
                category: "西餐",
                tags: ["辣", "墨西哥菜"],
              },
              { name: "地中海餐厅", category: "西餐", tags: ["健康", "海鲜"] },
              { name: "希腊餐厅", category: "西餐", tags: ["希腊菜", "沙拉"] },
            ];
            break;
          case "fastfood":
            presetFoods = [
              { name: "麦当劳", category: "快餐", tags: ["汉堡", "美式"] },
              { name: "肯德基", category: "快餐", tags: ["炸鸡", "美式"] },
              { name: "汉堡王", category: "快餐", tags: ["汉堡", "美式"] },
              { name: "赛百味", category: "快餐", tags: ["三明治", "健康"] },
              { name: "必胜客", category: "快餐", tags: ["披萨", "意式"] },
              { name: "德克士", category: "快餐", tags: ["炸鸡", "汉堡"] },
            ];
            break;
          default:
            alert("未知的预设列表");
            return;
        }

        // 显示预设列表预览
        let previewHTML = '<div class="preset-list">';
        presetFoods.forEach((food) => {
          previewHTML += `<div><strong>${food.name}</strong> - ${
            food.category
          } [${food.tags.join(", ")}]</div>`;
        });
        previewHTML += "</div>";

        // 显示确认对话框
        showConfirmModal(
          "添加预设食物列表",
          `确定要添加以下预设食物吗？<br>${previewHTML}`,
          function () {
            // 添加预设食物
            presetFoods.forEach((presetFood) => {
              // 检查是否已存在相同名称的食物
              if (!foods.some((food) => food.name === presetFood.name)) {
                const food = {
                  id:
                    Date.now().toString() +
                    Math.random().toString(36).substr(2, 5),
                  name: presetFood.name,
                  category: presetFood.category,
                  tags: presetFood.tags,
                  selectionCount: 0,
                  lastSelected: null,
                };

                foods.push(food);

                // 更新分类和标签
                if (!categories.includes(presetFood.category)) {
                  categories.push(presetFood.category);
                }

                presetFood.tags.forEach((tag) => {
                  if (!allTags.includes(tag)) {
                    allTags.push(tag);
                  }
                });
              }
            });

            // 保存数据
            saveFoods();
            saveCategories();
            saveTags();

            // 刷新视图
            refreshAllViews();
            updateCategoryFilter();
            updateTagFilters();

            alert("预设食物列表已添加！");
            closeModal();
          }
        );
      }

      // 备份数据
      function backupData() {
        // 准备要备份的数据
        const backupData = {
          foods: foods,
          categories: categories,
          tags: allTags,
          history: history,
          todaySelected: todaySelected,
          timestamp: new Date().toISOString(),
          version: "1.0",
        };

        // 创建备份文件
        const dataStr = JSON.stringify(backupData);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.setAttribute("href", url);
        a.setAttribute(
          "download",
          `food-decision-backup-${new Date()
            .toISOString()
            .slice(0, 10)}.foodbackup`
        );
        a.style.display = "none";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert("备份已创建！");
      }

      // 恢复备份
      function restoreData(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const backupData = JSON.parse(e.target.result);

            // 验证备份数据格式
            if (!backupData.foods || !Array.isArray(backupData.foods)) {
              throw new Error("无效的备份格式");
            }

            // 显示确认对话框
            showConfirmModal(
              "恢复备份",
              `确定要恢复此备份吗？这将替换您当前的所有数据。<br>备份日期：${new Date(
                backupData.timestamp
              ).toLocaleString()}<br>包含：${
                backupData.foods.length
              } 个食物项目，${
                backupData.history ? backupData.history.length : 0
              } 条历史记录。`,
              function () {
                // 恢复数据
                foods = backupData.foods;
                categories = backupData.categories || [
                  "中餐",
                  "西餐",
                  "快餐",
                  "健康餐",
                  "其他",
                ];
                allTags = backupData.tags || [];
                history = backupData.history || [];
                todaySelected = backupData.todaySelected || [];

                // 保存数据
                saveFoods();
                saveCategories();
                saveTags();
                saveHistory();
                saveTodaySelected();

                // 刷新视图
                refreshAllViews();

                alert("备份已恢复！");
                closeModal();
              }
            );
          } catch (error) {
            alert("恢复失败：" + error.message);
          }

          // 重置文件输入
          input.value = "";
        };

        reader.readAsText(file);
      }

      // 确认重置数据
      function confirmReset() {
        showConfirmModal(
          "重置所有数据",
          "警告：此操作将删除所有食物、分类、标签和历史记录数据，且无法恢复！确定要继续吗？",
          function () {
            // 重置所有数据
            foods = [];
            categories = ["中餐", "西餐", "快餐", "健康餐", "其他"];
            allTags = [];
            history = [];
            todaySelected = [];

            // 保存数据
            saveFoods();
            saveCategories();
            saveTags();
            saveHistory();
            saveTodaySelected();

            // 刷新视图
            refreshAllViews();
            updateCategoryFilter();
            updateTagFilters();

            alert("所有数据已重置！");
            closeModal();
          }
        );
      }

      // 显示确认对话框
      function showConfirmModal(title, message, confirmCallback) {
        const modal = document.getElementById("confirmModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalMessage = document.getElementById("modalMessage");
        const confirmButton = document.getElementById("confirmButton");

        modalTitle.textContent = title;
        modalMessage.innerHTML = message;

        // 设置确认按钮回调
        confirmButton.onclick = confirmCallback;

        // 显示对话框
        modal.style.display = "block";
      }

      // 关闭确认对话框
      function closeModal() {
        const modal = document.getElementById("confirmModal");
        modal.style.display = "none";
      }

      // 点击对话框外部关闭
      window.onclick = function (event) {
        const modal = document.getElementById("confirmModal");
        if (event.target === modal) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
